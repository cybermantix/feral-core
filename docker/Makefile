PROJECT_NAME=noloco_core

help:s
	@echo "Tribe Alpha Docker Kit"
	@echo
	@echo "PROJECT: ${PROJECT_NAME}"
	@echo
	@echo "The Makefile provides tasks on Linux/Mac computers."
	@echo
	@echo "Targets"
	@echo
	@echo "	help:		Show this help page. Default."
	@echo "	version:	Show version generated by git describe and update /var/version.txt."
	@echo " hooks:		Install Git commit hooks."
	@echo "	build:		Build the main application Docker image."
	@echo "	rebuild:	Build image without cache layers."
	@echo "	start|server:	Bring up development environment services."
	@echo "	stop:		Shutdown development environment services."
	@echo "	clean:		Remove all development environment containers, volumes, and networks."
	@echo "	term:		Start a interactive session for the application container ('php' service)."
	@echo "	sniff:		Check code style with PHP CodeSniffer."
	@echo "	test:		Bring up a test environment, run tests, then shutdown."
	@echo " docs:		Generate source code documentation."
	@echo
	@echo "Examples"
	@echo
	@echo "	1. Run tests and quality checks: make test"
	@echo "	2. Open a PHP terminal for a running dev environment: make term"
	@echo "	3. Refresh development environment: make stop clean server"
	@echo

install:
	chgrp -R 1688 .
	chmod -R 0775 .

hooks:
	cp scripts/pre-commit ../.git/hooks/

version:
	@git describe
	@git describe > var/version.txt

build:
	docker-compose -p ${PROJECT_NAME} build

rebuild:
	docker-compose -p ${PROJECT_NAME} build --no-cache

server:
	docker-compose -p ${PROJECT_NAME} up

start: server

stop:
	docker-compose -p ${PROJECT_NAME} stop

clean:
	docker-compose -p ${PROJECT_NAME} down -v

term:
	docker-compose -p ${PROJECT_NAME} exec app bash

sniff:
	vendor/bin/phpcs

test:
	docker-compose -p ${PROJECT_NAME} run --service-ports --use-aliases --rm app test
	docker-compose -p ${PROJECT_NAME} stop
	docker-compose -p ${PROJECT_NAME} down -v

validate-docs:
	swagger-cli validate ${DOCFILE}

docs:
	if [ ! -e phpDocumentor.phar ]; \
	then curl -OL http://phpdoc.org/phpDocumentor.phar; fi

	php phpDocumentor.phar

.DEFAULT: help
.PHONY: help install version build rebuild server start stop clean term sniff test docs
